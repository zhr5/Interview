1.自我介绍
2.一直做支付吗？这三年，这个支付项目做了哪些工作，讲讲，说了项目分层架构，我负责的方向
3.重复下单方案，下单场景拷打，下单和库存扣减哪种模式，会有什么问题，超卖，下单成功库存扣减失败，价格计算在什么环节，优惠扣减在什么环节，怎么原子性执行、完整流程每个环节差不多都问了方案。包括通过tcc下单减库存消耗大（讲通过数据对账机制做），积分扣减怎么办？购物车什么时机清空，会不会出现购物车清空失败
4.重复支付方案，没怎么问。（本来准备了今年双十一支付宝故障，看看下次能不能用)
5.业务体量？转进 订单的分库分表方案，想减少开销不想生成卖家库，卖家ID怎么查询订单。
6.为什么基于乐观锁修改订单状态，为什么不用悲观锁，mysql怎么实现，如何提供的两种锁机制，还知道哪些锁，死锁是怎么产生（转进mysql死锁问题排查）
7.rocketmq怎么实现分布式事务，原理，怎么保证消息不丢失。
8.不知道哪里提了一句二清，问二清方案，提到服务商模式，建行监管账户，支付宝使用服务商模式，那微信渠道怎么解决二清
说下你知道的二清哪些方案，建行会提供哪些二清方案（随口说了通联和易宝和银行合作)，你们的社区电商的运营模式（自营？商家）商品的配送履约怎么做的（自提），供应链货源怎么做，资金流的流程，


1.支付中台、开放平台、单体微服务改造
2.项目架构
3.下单链路详解

团购电商参考美团优选
购物车模式

库存扣减模式
1.加购减库存
2.下单减库存
3.支付减库存
注意购物车批量扣减

幂等校验、通用参数校验、优惠校验、价格计算、库存锁定、优惠锁定、下单、清空购物车。
支付成功、库存扣减、优惠扣减。
超时取消、库存回退、优惠返还。

订单分库分表

小型：
建立关联表  商家+订单号 
结合数据库中间件的智能查询功能
现在有一些先进的数据库中间件，它们可以对复杂的分库分表架构进行智能查询。
这些中间件可以解析卖家 ID 和订单号（包含哈希后的买家 ID）之间的关系，根据预先配置的分库分表规则，自动构建查询路径。
例如，Sharding - Sphere 是一款流行的数据库分库分表中间件。它可以通过配置分库分表策略，如按照订单号哈希分表，同时考虑卖家 ID 的查询需求。当卖家查询订单时，Sharding - Sphere 根据卖家 ID 和订单号的关联关系（通过配置和规则解析），智能地引导查询到正确的分库分表组合，而不需要遍历所有的库和表。
大型：
CANAL  ES

场景：订单超时关闭+补单任务查询订单状态+异步通知订单请求  读多写少
悲观锁：selct t.status from t where order_no=' ' for update;
乐观锁

select version from t where order_no=' ';
update status='' and version=version=1 where where order_no=' ' and version='version';

mysql锁机制复习

rocketMQ/Kafka复习
https://www.yuque.com/fcant/sys/pe6gvp

二清

电商购物时价格计算的环节及方式如下：

### 前端计算
- **实时总价计算**：在购物车页面，前端通常会进行简单的价格计算，如根据商品的单价和用户输入的数量，实时计算出每件商品的小计金额，并汇总得出购物车中所有商品的总价。例如，用户在购物车中添加了3件单价为20元的商品，前端会立即计算出该商品的小计为60元，并更新购物车的总价.
- **优惠折扣初步展示**：对于一些明确的、无需复杂逻辑判断的优惠折扣，前端也会进行初步计算和展示。比如，商品有直接的8折优惠，前端可以在用户添加商品到购物车时，就计算出折后价格并显示给用户.

### 后端计算
- **复杂优惠逻辑计算**：当购物车勾选完提交订单时，后端会进行更为复杂和精确的价格计算。因为后端能够获取到更全面的信息，如用户的会员等级、可用优惠券、积分余额、商品的库存状态以及各种促销活动的详细规则等，从而根据这些信息来计算最终的订单价格 。例如，“满300减50”“满500打8折”等满减、满折活动，以及不同商品、不同店铺的优惠券叠加使用，还有积分抵扣现金等复杂的优惠组合，都需要后端根据具体的业务规则进行准确计算.
- **库存与价格关联计算**：后端还会检查商品的库存情况，若库存不足，可能会影响商品的实际价格或导致无法下单。比如，某商品标注的价格是在有一定库存基础上的优惠价，当库存低于某个阈值时，价格可能会恢复原价，或者该商品无法再以优惠价购买，这些都需要后端在计算价格时进行判断和处理.
- **运费计算**：根据用户购买商品的重量、体积、配送地址等因素计算运费，并将其加入到订单总价中。不同的商品可能有不同的运费计算方式，如按重量计费、按件数计费等，后端需要综合考虑这些因素来准确计算运费.
- **价格更新与一致性保证**：在订单生成后，如果商品价格发生变化，后端会根据相应的规则进行处理，如是否支持保价、是否需要重新计算价格等，以确保订单价格的准确性和一致性.

银行提供的二清方案主要有以下几种：
银行存管账户模式
模式介绍：银行会为电商平台的二级商户开立虚拟子账户，并承担资金监管职责。在该模式下，资金的流向是用户付款先进入平台在银行的存管账户，然后根据交易情况，银行再将资金结算到二级商户的虚拟子账户.
优势：实现了一定程度的资金隔离和监管，保障了二级商户资金的相对安全，有助于增强平台的可信度和稳定性.
局限：存管账户的虚拟账户对外独立性存在争议，且该模式准入门槛高、监督严格，可能会影响用户体验，例如提现到账时间等方面可能不如其他模式便捷.
银行内部账户模式
模式介绍：通过开立内部过渡户来提供交易资金结算服务。银行内部会对不同平台及其二级商户的资金进行专门管理和核算，以实现资金的流转和结算.
优势：具有一定的风险隔离效果，银行可以利用自身的风险管控体系，对交易资金进行有效的监控和管理，保障资金的安全和合规流转.
局限：这种模式在实践中仍需探索和完善，其业务流程和管理规范相对复杂，需要银行与平台之间进行深入的沟通和协调，以确保各方的权益和责任得到明确划分.
银企直连模式
模式介绍：电商平台直接连接银行核心交易系统，通过银行支付网关提供账户管理、在线收付、交易查询、转账支付、回单下载、资金清结算等服务。平台的交易数据可以实时传输到银行系统，银行根据这些数据进行相应的资金处理.
优势：能够实现账务信息银企同步，集中管理资金，提升支付效率，适合大中型企业。企业可以及时了解资金动态，便于进行财务管理和决策.
局限：对接周期长，通道费用高，对企业的技术和管理水平要求也较高，需要投入一定的人力、物力和时间成本来完成系统对接和维护工作.
实体账户分账模式
模式介绍：即母实子虚模式，需要在银行开立资金结算账户，二级商户在银行并无实际的独立账户，而是通过虚拟记账的方式来记录其资金的变动情况。用户付款后，资金先进入平台的实体资金结算账户，然后银行根据平台的指令和交易记录，在内部进行虚拟分账，将相应的资金份额标记为二级商户的可支配资金.
优势：资金的管理和结算相对集中，便于银行进行统一的监管和风险控制，同时也能满足平台对资金灵活调配的需求.
局限：二级商户对资金的掌控感相对较弱，可能会对平台的信任度产生一定影响，而且在资金的明细核算和对账方面可能会面临一些挑战，需要银行和平台建立完善的信息沟通和对账机制.
内部户分账模式
模式介绍：即母虚子虚模式，通过开立虚拟账户进行收单后的记账，所有的资金流动都在虚拟账户体系内进行记录和核算，并不涉及实际的资金划转，直到最终结算时才进行真实资金的交割.
优势：可以提高资金结算的效率和灵活性，减少了实际资金划转的环节，降低了资金风险和操作成本.
局限：虚拟账户的管理和监控需要依赖银行强大的信息系统和风险防控能力，对银行的技术水平和管理要求较高。如果系统出现故障或漏洞，可能会导致资金数据的错误或风险事件的发生.

监管户分账给二级商户通常是由平台指令触发的，以下是具体介绍：
第三方支付平台分账
以微信和支付宝为例，当用户完成支付后，资金会先进入到一个待分账的状态，此时平台会根据与二级商户的约定以及业务规则，向支付平台发送分账指令.
支付宝直付通中，平台通过 alipay.trade.settle.confirm 等统一收单确认结算接口触发结算请求，告知支付宝将对应的交易订单资金结算至二级商户的收款账户.
微信支付中，服务商或商户判断达到分账条件，如用户确认收货后，便可发起分账指令，支付平台收到指令后对指定交易订单进行分账处理，并进行交易资金解冻，将资金分账到二级商户的待结算账户.
银行分账
内部户分账模式：银行根据平台发送的指令，在虚拟账户体系内进行相应的记账操作，调整各虚拟账户的资金余额，完成分账。所有的资金流动都在虚拟账户体系内进行记录和核算，并不涉及实际的资金划转，直到最终结算时才进行真实资金的交割.
实体账户分账模式：银行同样需要依据平台的指令，将资金从监管账户或其他相关账户划拨至二级商户的实体资金结算账户.
通过平台指令触发分账，可以确保资金按照平台与二级商户之间的约定进行准确、及时的分配，同时也便于平台对整个交易流程和资金流向进行管理和监控，保障各方的权益

银行监管账户模式和支付宝、微信提供的二清方案存在多方面区别，具体如下：
主体性质与监管力度
银行监管账户模式：银行作为金融机构，受到严格的金融监管法规约束，在资金监管方面具有较高的权威性和专业性。其监管力度强，对资金的流向、使用等各方面都有严格的把控和监督机制，能够有效保障资金的安全和合规性.
支付宝、微信二清方案：支付宝和微信是第三方支付平台，虽然也受到相关监管，但它们的业务模式和监管重点与银行有所不同。其监管更多侧重于支付环节的合规性、反洗钱等方面，在资金监管的全面性和深度上相对银行监管账户模式可能较弱 。
账户体系架构
银行监管账户模式：通常会为电商平台的二级商户开立虚拟子账户或实体子账户，构建起一套较为复杂的子母账户体系。这些子账户与平台的监管账户相互关联，形成层级分明的资金管理架构，便于对不同商户的资金进行隔离和管理.
支付宝、微信二清方案：主要是通过在自身平台上为二级商户开设二级商户号或虚拟账户来实现资金的分账和管理。账户体系相对较为简洁，与银行的账户体系相对独立，但与平台的业务系统紧密结合，能够快速响应用户的支付和分账指令.
资金流转路径
银行监管账户模式：用户支付的资金一般先进入平台在银行的监管账户，然后银行根据平台或商户的指令，将资金从监管账户划拨至二级商户的子账户或其他相关账户。资金的流转过程相对较为规范和透明，每一步都有明确的记录和监管.
支付宝、微信二清方案：用户支付的资金首先进入支付宝或微信的支付系统，然后根据平台的分账指令，将资金分配到相应的二级商户账户或其他收款方账户。资金在支付宝或微信平台内部的流转相对较快，但对于外部监管机构来说，资金的流向追踪可能相对复杂一些.
分账功能与灵活性
银行监管账户模式：分账功能一般是基于银行的系统和规则来实现，分账的比例、时间等设置相对较为固定，灵活性较差。但银行的分账系统具有较高的稳定性和可靠性，能够满足大规模资金的分账需求.
支付宝、微信二清方案：分账功能更加灵活多样，平台可以根据自身的业务需求和与商户的协议，自主设置分账比例、分账时间、分账条件等。同时，还可以支持多种分账方式，如按订单金额、按商品数量、按利润分成等，能够更好地适应不同行业和企业的多样化需求.
风险防控能力
银行监管账户模式：银行拥有完善的风险防控体系和专业的风险管理人员，能够对资金的风险进行全面评估和监控。通过建立风险预警机制、资金冻结机制等措施，及时发现和处置潜在的风险，保障资金的安全.
支付宝、微信二清方案：支付宝和微信也具备一定的风险防控能力，通过大数据分析、风险模型等技术手段，对交易风险进行识别和预警。但其风险防控重点主要在于支付环节的风险，对于商户的经营风险和资金风险的防控相对有限。
接入难度与成本
银行监管账户模式：接入银行监管账户模式通常需要平台与银行进行深入的合作洽谈，签订相关的协议和合同，同时还需要满足银行的一系列资质审核和技术对接要求。接入难度较大，成本较高，且对接过程相对较长.
支付宝、微信二清方案：接入支付宝、微信的二清方案相对较为便捷，平台只需按照其规定的流程和要求，完成相关的注册、认证和技术对接即可。接入成本相对较低，且能够快速上线运营，适合中小规模的电商平台和创业型企业.

对接了支付宝、微信、龙支付、云闪付等支付渠道的平台使用银行存管模式解决二清问题时，并非一定要在支付宝等渠道开通服务商商户，以下是具体情况分析：
银行存管模式与支付渠道服务商商户的关系
银行存管模式主要是为了保障资金的安全与合规，将平台的资金流纳入银行的监管体系之下，通过银行的专业管理和监督机制，确保资金的流向清晰、可追溯，防止平台挪用资金或出现二清风险.
在支付渠道开通服务商商户则是为了能够使用该支付渠道的支付服务，实现用户通过该渠道向平台或平台商户进行支付的功能，两者的主要目的和功能有所不同.
不同支付渠道的情况
支付宝：如果平台对接了支付宝且采用银行存管模式，是否需要开通支付宝服务商商户，取决于平台的具体业务模式和需求。若平台只是单纯地使用支付宝作为支付渠道，让用户通过支付宝完成支付，而资金的管理和结算主要通过银行存管来完成，那么可以不开通支付宝服务商商户。但如果平台希望借助支付宝的一些特殊功能，如分账功能、营销工具等，且这些功能需要服务商商户身份才能使用，那么就需要开通.
微信：同理，对于微信支付，平台在使用银行存管模式的情况下，若仅需基本的支付功能，可不开通微信服务商商户。但如果要使用微信支付的分账功能、企业付款到零钱等功能，通常需要开通微信服务商商户，并进行相应的资质审核和配置.
龙支付、云闪付：龙支付和云闪付的情况与上述类似。如果平台只是利用它们的支付通道，银行存管模式能够满足资金管理需求时，可不开通其服务商商户。若平台想进一步整合这些支付渠道的特色功能或服务，可能就需要开通对应的服务商商户身份来实现 。
